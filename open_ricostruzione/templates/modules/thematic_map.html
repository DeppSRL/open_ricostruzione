{% load l10n %}

<div role="tabpanel">

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#tab_danno" aria-controls="tab_danno" role="tab" data-toggle="tab" id="handle_danno">Mappa Danno</a></li>
        <li role="presentation"><a href="#tab_attuazione" aria-controls="tab_attuazione" role="tab" data-toggle="tab" id="handle_attuazione">Mappa Attuazione</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane fade active" id="tab_danno"><div id="mappa_danno" class="map"></div></div>
        <div role="tabpanel" class="tab-pane fade " id="tab_attuazione"><div id="mappa_attuazione" class="map"></div></div>
    </div>

</div>


<script type="text/javascript">

    var bounds, center, comuniEmilia;

    function prepare_data(){

        bounds = {
                'sw': {'lat':{{ map_bounds.sw.lat|unlocalize }} ,'lon':{{ map_bounds.sw.lon|unlocalize }} },
                'ne': {'lat':{{ map_bounds.ne.lat|unlocalize }} ,'lon':{{ map_bounds.ne.lon|unlocalize }} }
            };

        center = {'lat': {{ map_center.lat|unlocalize }},'lon':{{ map_center.lon|unlocalize }} };
        var comuniData ={
            {# creates the dict with data using istat code as key to retrieve Comune polygon  #}
            {% for t in map_values %}
                "{{ t.istat_code }}": {
                    "label": "{{ t.label }}",
                    "url": "",
                    "value": "{{ t.value|default:"0" }}".replace(/,/g, '.')
                }{% if not forloop.last %},{% endif %}
            {% endfor %}

        };

        $.each(comuniEmilia.features, function(index, feature){
            var id = feature.properties.codice;

            if (id in comuniData){
                feature.properties.url = comuniData[id].url;
                feature.properties.label = comuniData[id].label;
                feature.properties.value = comuniData[id].value;

            }
        });
    }

    var initialized_map = false;
    function init_thematic_map(event){
        console.log("init_thematic_map");
        if(initialized_map==false){
            thematic_map('attuazione', event.data.bounds, event.data.center, event.data.comuniEmilia);
            initialized_map = true;
        }
    }



    $(document).ready(function(){
        prepare_data();
        {#        on page load creates danno map#}
        thematic_map('danno', bounds, center, comuniEmilia);

{#        $("#tab_attuazione").on('shown',{map_type:'attuazione',bounds:bounds,center:center,comuniEmilia: comuniEmilia},init_thematic_map);#}
        $('a#handle_attuazione').on('shown.bs.tab',{map_type:'attuazione',bounds:bounds,center:center,comuniEmilia: comuniEmilia},init_thematic_map);

    });


    // get color depending on population density value
    function getColor(d) {
        return d > 20000000 ? '#800026' :
               d > 15000000  ? '#BD0026' :
               d > 10000000  ? '#E31A1C' :
               d > 5000000  ? '#FC4E2A' :
               d > 1000000   ? '#FD8D3C' :
               d > 500000   ? '#FED976' :
                          '#FFEDA0';
    }


    {# adds legend to map #}
    function add_legend(map){
        var legend = L.control({position: 'bottomright'});

            legend.onAdd = function (map) {

                var div = L.DomUtil.create('div', 'map_info legend'),
                    grades = [0, 10, 20, 50, 100, 200, 500, 1000],
                    labels = [],
                    from, to;

                for (var i = 0; i < grades.length; i++) {
                    from = grades[i];
                    to = grades[i + 1];

                    labels.push(
                        '<i style="background:' + getColor(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };

        legend.addTo(map);
    }


</script>